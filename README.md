# Kubernetes Grafana

This project is about running [Grafana](https://grafana.com/) on [Kubernetes](https://kubernetes.io/) with [Prometheus](https://prometheus.io/) as the datasource in a very opinionated and entirely declarative way. This allows easily operating Grafana highly available as if it was a stateless application - no need to run a clustered database for your dashboarding solution anymore!

Note that at this point this is primarily about getting into the same state as [kube-prometheus](https://github.com/coreos/prometheus-operator/tree/master/contrib/kube-prometheus) currently is. Once completed improvements to the dashboards themselves can be made.

## What and why is happening here?

This repository exists because the Grafana stack in [kube-prometheus](https://github.com/coreos/prometheus-operator/tree/master/contrib/kube-prometheus) has gotten close to unmaintainable due to the many steps of generation and it's a very steep learning curve for newcomers.

Since Grafana v5, Grafana can be provisioned with dashboards from files. This project is primarily about generating a set of useful Grafana dashboards for use with and on Kubernetes using with Prometheus as the datasource.

This repository contains files that will migrate the current state of the Grafana stack located in [kube-prometheus](https://github.com/coreos/prometheus-operator/tree/master/contrib/kube-prometheus) over to be fully generated by [jsonnet](http://jsonnet.org/) using the [grafana/grafonnet-lib](https://github.com/grafana/grafonnet-lib) and [ksonnet/ksonnet-lib](https://github.com/ksonnet/ksonnet-lib). It is yet to be determined whether this should eventually be merged back into kube-prometheus, or whether kube-prometheus should consume this repository as a package.

In this repository everything is generated via jsonnet:

* The [Grafana dashboard sources configuration](https://github.com/brancz/kubernetes-grafana/blob/master/src/kubernetes-jsonnet/grafana/configs/dashboard-sources/dashboards.jsonnet).
* The [Grafana datasources configuration](https://github.com/brancz/kubernetes-grafana/blob/master/src/kubernetes-jsonnet/grafana/configs/datasources/prometheus.jsonnet).
* The [Grafana dashboard definitions](https://github.com/brancz/kubernetes-grafana/tree/master/src/kubernetes-jsonnet/grafana/configs/dashboard-definitions) with the help of [grafana/grafonnet-lib](https://github.com/grafana/grafonnet-lib).
* The [Grafana Kubernetes manifests](https://github.com/brancz/kubernetes-grafana/tree/master/src/kubernetes-jsonnet/grafana) with the help of [ksonnet/ksonnet-lib](https://github.com/ksonnet/ksonnet-lib).

With a single jsonnet command the whole stack is generated and can be applied against a Kubernetes cluster.

## Prerequisites

You need a running Kubernetes cluster in order to try this out, with the kube-prometheus stack deployed on it as have Docker installed to and be able to mount volumes correctly (this is **not** the case when using the Docker host of minikube).

For trying this out provision [minikube](https://github.com/kubernetes/minikube) with these settings:

```
minikube start --kubernetes-version=v1.9.3 --memory=4096 --bootstrapper=kubeadm --extra-config=kubelet.authentication-token-webhook=true --extra-config=kubelet.authorization-mode=Webhook --extra-config=scheduler.address=0.0.0.0 --extra-config=controller-manager.address=0.0.0.0
```

And deploy the kube-prometheus stack on it (this is necessary as the kube-prometheus stack provides us with a Prometheus server that has all the data we want to create dashboards with in Grafana):

```
mkdir -p $GOPATH/src/github.com/coreos
git clone https://github.com/coreos/prometheus-operator $GOPATH/src/github.com/coreos/prometheus-operator
cd $GOPATH/src/github.com/coreos/prometheus-operator/contrib/kube-prometheus
hack/cluster-monitoring/minikube-deploy
```

## Usage

Clone this repository:

```
git clone https://github.com/brancz/kubernetes-grafana && cd kubernetes-grafana
```

Then build the Grafana stack and deploy the it (this command can be used on subsequent edits to the Grafana dashboards as well to see changes live in Grafana):

```
./deploy.sh
```

At the end the script opens your browser with the new Grafana deployment, configuration and dashboards for you to browse.

# Roadmap

There are a number of things missing for the Grafana stack and tooling to be fully migrated.

**If you are interested in working on any of these, please open a respective issue to avoid duplicating efforts.**

1. Migrate [all existing dashboards](https://github.com/coreos/prometheus-operator/tree/master/contrib/kube-prometheus/assets/grafana) to jsonnet. The missing dashboards are:
    * Deployment
    * Kubernetes Capacity Planning
    * Kubernetes control plane status
    * Kubernetes resource requests (could probably be folded into capacity planning dashboard)
    * Pods
    * StatefulSets

2. Bin packing ConfigMaps. The kube-prometheus tooling includes a tool to bin-pack Grafana dashboards into ConfigMaps. This is necessary as Grafana dashboard json definitions can get very large and exceed the ConfigMap size limit of 1Mb. The previous tool was built in bash, which is not only hard to maintain but also breaks the workflow of this repo which uses jsonnet for everything. Eventually this should be extracted into a separate repository, but initially should be developed here to ensure it serves the purpose perfectly.

3. A tool to review Grafana dashboard changes on PRs. While reviewing jsonnet code is a lot easier than the large Grafana json sources, it's hard to imagine what that will actually end up looking like once rendered. Ideally a production-like environment is spun up and produces metrics to be graphed, then a tool could take a screenshot and [Grafana snapshot](http://docs.grafana.org/plugins/developing/snapshot-mode/) of the rendered Grafana dashboards. That way the changes can not only be reviewed in code but also visually. Similar to point 2 this should eventually be it's own project.
